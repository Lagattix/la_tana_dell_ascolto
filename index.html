<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>La tana dell'ascolto</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: white;
    margin: 0;
    padding: 20px;
  }
  button {
    cursor: pointer;
  }
  .card {
    background: #1e1e1e;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
  }
  img {
    max-width: 100%;
    border-radius: 10px;
  }
  input, textarea {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    margin-bottom: 10px;
    border-radius: 6px;
    border: none;
  }
  .hidden {
    display: none;
  }
</style>
</head>
<body>

<h1>ðŸŽ§ La tana dell'ascolto</h1>

<!-- CREA PODCAST -->
<div class="card">
  <h2>Crea podcast</h2>
  <input id="pImage" type="file" accept="image/*">
  <input id="pTitle" placeholder="Titolo podcast">
  <input id="pAuthor" placeholder="Autore">
  <textarea id="pDesc" placeholder="Descrizione"></textarea>
  <button onclick="createPodcast()">Crea podcast</button>
</div>

<!-- LISTA PODCAST -->
<div id="podcastList"></div>

<!-- DETTAGLIO PODCAST -->
<div id="podcastDetail" class="hidden card"></div>

<script>
/* IDENTITÃ€ UTENTE */
let currentUserId = localStorage.getItem("userId");
if (!currentUserId) {
  currentUserId = crypto.randomUUID();
  localStorage.setItem("userId", currentUserId);
}

/* DATI */
let podcasts = [];
let selectedPodcast = null;

/* CREA PODCAST */
function createPodcast() {
  const imgFile = pImage.files[0];
  const title = pTitle.value;
  const author = pAuthor.value;
  const desc = pDesc.value;

  if (!imgFile || !title || !author) {
    alert("Immagine, titolo e autore obbligatori");
    return;
  }

  const reader = new FileReader();
  reader.onload = () => {
    podcasts.push({
      id: Date.now(),
      title,
      author,
      desc,
      image: reader.result,
      creatorId: currentUserId,
      episodes: []
    });
    renderList();
  };
  reader.readAsDataURL(imgFile);
}

/* LISTA */
function renderList() {
  podcastList.innerHTML = "";
  podcasts.forEach(p => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <img src="${p.image}">
      <h3>${p.title}</h3>
      <p>${p.author}</p>
      <button onclick="openPodcast(${p.id})">Apri</button>
    `;
    podcastList.appendChild(div);
  });
}

/* APRI PODCAST */
function openPodcast(id) {
  selectedPodcast = podcasts.find(p => p.id === id);
  podcastDetail.classList.remove("hidden");

  let html = `
    <img src="${selectedPodcast.image}">
    <h2>${selectedPodcast.title}</h2>
    <p>${selectedPodcast.desc}</p>
    <h3>Episodi</h3>
  `;

  if (selectedPodcast.episodes.length === 0) {
    html += `<p>Nessun episodio ancora disponibile</p>`;
  } else {
    selectedPodcast.episodes.forEach(ep => {
      html += `
        <div class="card">
          <strong>${ep.title}</strong>
          <audio controls src="${ep.audio}"></audio>
        </div>
      `;
    });
  }

  if (selectedPodcast.creatorId === currentUserId) {
    html += `
      <button id="addEpisodeBtn">âž• Aggiungi episodio</button>
      <div id="episodeForm" class="hidden">
        <input id="epTitle" placeholder="Titolo episodio">
        <input id="epAudio" type="file" accept="audio/*">
        <button id="saveEpisode">Salva episodio</button>
      </div>
    `;
  }

  podcastDetail.innerHTML = html;

  /* EVENTI */
  if (selectedPodcast.creatorId === currentUserId) {
    document.getElementById("addEpisodeBtn").onclick = () => {
      document.getElementById("episodeForm").classList.toggle("hidden");
    };

    document.getElementById("saveEpisode").onclick = () => {
      const title = epTitle.value;
      const file = epAudio.files[0];
      if (!title || !file) return alert("Titolo e audio obbligatori");

      const reader = new FileReader();
      reader.onload = () => {
        selectedPodcast.episodes.push({
          id: Date.now(),
          title,
          audio: reader.result
        });
        openPodcast(selectedPodcast.id);
      };
      reader.readAsDataURL(file);
    };
  }
}
</script>

</body>
</html>
